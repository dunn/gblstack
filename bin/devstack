#!/usr/bin/env ruby

require 'pathname'
require 'yaml'

this_file = __FILE__
this_file = File.readlink(this_file) while File.symlink?(this_file)
root = Pathname(File.expand_path('../..', this_file))

compose_file = root.join('docker-compose.yml').to_s
dependencies = YAML.load(File.read(root.join('sets.yml')))

subcommand = ARGV.shift
cmdline = case subcommand
          when 'init-core'
            cmd = ARGV.collect { |core| "bin/solr create_core -c #{core}-development -d /solr_configs/#{core}" }.join(' && ')
            ['docker-compose', '-f', compose_file, 'exec', 'solr', 'bash', '-c', cmd]
          else
            services = ARGV.collect { |arg| dependencies[arg] || arg }.flatten.sort.uniq
            ['docker-compose', '-f', compose_file, subcommand] + services
          end

Kernel.exec(*cmdline)
