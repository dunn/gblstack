#!/usr/bin/env ruby

require 'pathname'
require 'yaml'

def usage
  output = %x(docker-compose 2>&1).split(/\nCommands:\n/).last
  commands = Hash[output.lines.collect { |line| line.strip.split(/\s+/,2) }]
  commands['update'] = 'Pull the latest devstack command/configs from github'
  $stderr.puts %{Usage:\n  devstack [COMMAND] [ARGS...]\n\nCommands:}
  commands.sort.each do |command|
    $stderr.puts '  %-18s %s' % command
  end
end

this_file = __FILE__
this_file = File.readlink(this_file) while File.symlink?(this_file)
root = Pathname(File.expand_path('../..', this_file))

compose_file = root.join('docker-compose.yml').to_s
dependencies = YAML.load(File.read(root.join('sets.yml')))

subcommand = ARGV.shift
working_dir = Dir.pwd
cmdline = case subcommand
          when nil, 'help' then nil
          when 'update'
            working_dir = root.to_s
            %w[git pull origin]
          else
            services = ARGV.collect { |arg| dependencies[arg] || arg }.flatten.sort.uniq
            ['docker-compose', '-f', compose_file, subcommand] + services
          end

if cmdline.nil?
  usage
else
  Dir.chdir(working_dir) { Kernel.exec(*cmdline) }
end
